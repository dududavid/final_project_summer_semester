<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<a href="index.html">â¬… ×—×–×¨×”</a>
<div id="project"></div>

<script>
    function getParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    const id = parseInt(getParam("id"));

    async function loadProject() {
        try {
            let response = await fetch(`/p/${id}`);
            if (!response.ok) {
                document.getElementById("project").innerHTML = "<p>×”×¤×¨×•×™×§×˜ ×œ× × ××¦×</p>";
                return;
            }
            let project = await response.json();
            renderProject(project);
        } catch (err) {
            document.getElementById("project").innerHTML = "<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×¨×•×™×§×˜</p>";
        }
    }

    function renderProject(project) {
        let voted = JSON.parse(localStorage.getItem("votedProjects")) || [];
        voted = voted.map(Number); // ×œ×•×•×“× ×©×›×œ ×”×¢×¨×›×™× ×”× ××¡×¤×¨×™×
        let disabled = voted.includes(Number(project.id)) ? "disabled" : "";

        document.getElementById("project").innerHTML = `
        <div class="project-page">
          <h1>${project.name}</h1>
          <img src="/images/${project.myFileName}?t=${Date.now()}" alt="${project.name}">
          <p>${project.description}</p>
          <p><strong>×§×•×œ×•×ª:</strong> <span id="vote-count">${project.votes}</span></p>
          <button id="vote-btn" onclick="vote(${project.id})" ${disabled}>ğŸ‘ ×”×¦×‘×¢</button>
          <p id="vote-message" style="color: green; margin-top: 10px;"></p>
        </div>
    `;
    }
    function getUserId() {
        let userId = localStorage.getItem("userId");
        if (!userId) {
            userId = Date.now().toString(); // ××• ××¤×©×¨ ×’× ××©×”×• ×›××• UUID
            localStorage.setItem("userId", userId);
        }
        return userId;
    }
    async function vote(id) {
        const userId = getUserId();
        try {
            const response = await fetch(`/p/${id}/vote`, {
            method: "POST",
                headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId })
        });
        const data = await response.json();

        alert(data.message);
        // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×•××¡×¤×¨ ×”×¦×‘×¢×•×ª
        const btn = document.getElementById(`vote-btn-${id}`) || document.getElementById("vote-btn");
        if (btn) btn.disabled = true;

        if (data.votes !== undefined) {
            const voteCountEl = document.getElementById(`vote-count-${id}`) || document.getElementById("vote-count");
            if (voteCountEl) voteCountEl.textContent = data.votes;
        }

    } catch (err) {
        console.error(err);
        alert("×©×’×™××” ×‘×”×¦×‘×¢×”");
    }
    }
    loadProject();
</script>
</body>
</html>